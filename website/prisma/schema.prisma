generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  emailVerified        DateTime?
  passwordHash         String?
  firstName            String
  lastName             String
  phone                String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?
  country              String             @default("US")
  dateOfBirth          DateTime?
  companyName          String?
  alternatePhone       String?
  preferredContact     String             @default("EMAIL")
  profileCompleted     Boolean            @default(false)
  notificationsEnabled Boolean            @default(true)
  autoRegister         Boolean            @default(true)
  plan                 String             @default("FREE")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  planExpiresAt        DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  lastLoginAt          DateTime?
  apiKeys              ApiKey[]
  products             Product[]
  registrations        Registration[]
  sessions             Session[]
  warrantyContracts    WarrantyContract[]

  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ApiKey {
  id         String    @id @default(cuid())
  userId     String
  key        String    @unique
  name       String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
}

model Product {
  id                 String            @id @default(cuid())
  userId             String
  productName        String
  manufacturerName   String
  manufacturerId     String?
  category           String?
  modelNumber        String?
  serialNumber       String?
  sku                String?
  upc                String?
  purchaseDate       DateTime?
  purchasePrice      Float?
  retailer           String?
  warrantyDuration   Int?
  warrantyStartDate  DateTime?
  warrantyExpiry     DateTime?
  warrantyType       String?
  warrantyContractId String?           @unique
  imageUrls          String
  extractedData      String
  confidenceScore    Float?
  status             String            @default("PROCESSING")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  manufacturer       Manufacturer?     @relation(fields: [manufacturerId], references: [id])
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  warrantyContract   WarrantyContract? @relation(fields: [warrantyContractId], references: [id])
  documents          ProductDocument[]
  registrations      Registration[]

  @@index([userId])
  @@index([manufacturerId])
  @@index([serialNumber])
  @@index([status])
}

model ProductDocument {
  id            String   @id @default(cuid())
  productId     String
  type          String
  fileUrl       String
  fileName      String
  fileSize      Int
  mimeType      String
  ocrText       String?
  ocrConfidence Float?
  createdAt     DateTime @default(now())
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Manufacturer {
  id                  String                     @id @default(cuid())
  name                String                     @unique
  normalizedName      String                     @unique
  website             String?
  supportEmail        String?
  supportPhone        String?
  registrationUrl     String?
  hasApi              Boolean                    @default(false)
  apiEndpoint         String?
  apiDocs             String?
  automationAvailable Boolean                    @default(false)
  automationScript    String?
  scriptVersion       Int                        @default(1)
  lastTestedAt        DateTime?
  successRate         Float                      @default(0)
  logo                String?
  category            String?
  isActive            Boolean                    @default(true)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  formTemplates       ManufacturerFormTemplate[]
  products            Product[]
  registrations       Registration[]

  @@index([normalizedName])
  @@index([successRate])
}

model Registration {
  id                 String                @id @default(cuid())
  productId          String
  userId             String
  manufacturerId     String?
  registrationMethod String
  manufacturerUrl    String?
  confirmationCode   String?
  confirmationEmail  String?
  status             String                @default("PENDING")
  statusMessage      String?
  automationAttempts Int                   @default(0)
  lastAttemptAt      DateTime?
  automationScript   String?
  scriptVersion      Int?
  errorMessage       String?
  errorScreenshot    String?
  errorLog           String?
  assistedPdfUrl     String?
  emailDraftSent     Boolean               @default(false)
  userCompletedAt    DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  completedAt        DateTime?
  manufacturer       Manufacturer?         @relation(fields: [manufacturerId], references: [id])
  product            Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  attempts           RegistrationAttempt[]

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
}

model RegistrationAttempt {
  id             String       @id @default(cuid())
  registrationId String
  attemptNumber  Int
  method         String
  scriptVersion  Int?
  startedAt      DateTime     @default(now())
  completedAt    DateTime?
  success        Boolean
  errorMessage   String?
  errorType      String?
  screenshot     String?
  htmlSnapshot   String?
  durationMs     Int?
  registration   Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@index([registrationId])
  @@index([success])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  actionUrl String?
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

model EmailLog {
  id          String    @id @default(cuid())
  userId      String?
  type        String
  recipient   String
  subject     String
  sent        Boolean   @default(false)
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  error       String?
  messageId   String?
  createdAt   DateTime  @default(now())

  @@index([recipient])
  @@index([createdAt])
}

model AiExtractionMetric {
  id                  String   @id @default(cuid())
  productId           String?
  model               String
  documentType        String
  latencyMs           Int
  tokenCount          Int?
  cost                Float?
  confidenceScore     Float?
  manualEditsRequired Boolean  @default(false)
  createdAt           DateTime @default(now())

  @@index([model])
  @@index([documentType])
  @@index([createdAt])
}

model SystemHealth {
  id                  String   @id @default(cuid())
  ocrServiceUp        Boolean
  automationServiceUp Boolean
  emailServiceUp      Boolean
  databaseUp          Boolean
  queueLength         Int
  queueOldestJobAge   Int?
  avgRegistrationTime Int?
  successRate24h      Float?
  errorRate24h        Float?
  cpuUsage            Float?
  memoryUsage         Float?
  diskUsage           Float?
  timestamp           DateTime @default(now())

  @@index([timestamp])
}

model SupportTicket {
  id          String    @id @default(cuid())
  userId      String?
  subject     String
  description String
  status      String    @default("OPEN")
  priority    String    @default("NORMAL")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  closedAt    DateTime?

  @@index([status])
  @@index([createdAt])
}

model UserFeedback {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  rating    Int?
  comment   String?
  context   String?
  createdAt DateTime @default(now())

  @@index([type])
  @@index([rating])
}

model WarrantyContract {
  id                 String    @id @default(cuid())
  userId             String
  productId          String?   @unique
  documentUrl        String
  documentType       String
  fileName           String
  fileSize           Int
  contractText       String
  ocrConfidence      Float?
  aiSummary          String?
  confidenceScore    Float?
  duration           String?
  durationMonths     Int?
  startDate          DateTime?
  expiryDate         DateTime?
  coverageItems      String    @default("[]")
  exclusions         String    @default("[]")
  limitations        String    @default("[]")
  claimProcedure     String?
  claimContacts      String    @default("{}")
  requiredDocs       String    @default("[]")
  criticalDates      String    @default("[]")
  transferable       Boolean?
  extendedOptions    String?
  aiModel            String    @default("claude-3-5-sonnet-20241022")
  promptVersion      String    @default("1.0")
  analysisDate       DateTime  @default(now())
  reanalyzedAt       DateTime?
  status             String    @default("PROCESSING")
  errorMessage       String?
  criticalHighlights String    @default("[]")
  warningHighlights  String    @default("[]")
  infoHighlights     String    @default("[]")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  product            Product?
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiryDate])
}

model ManufacturerFormTemplate {
  id                String           @id @default(cuid())
  manufacturerId    String
  formName          String
  formUrl           String
  formType          String           @default("WEB_FORM")
  screenshotUrl     String?
  videoUrl          String?
  fieldMappings     String
  instructions      String
  lastVerified      DateTime?
  verifiedWorking   Boolean          @default(true)
  difficulty        String           @default("EASY")
  estimatedTime     Int              @default(5)
  requiresCaptcha   Boolean          @default(false)
  requiresAccount   Boolean          @default(false)
  timesUsed         Int              @default(0)
  successCount      Int              @default(0)
  failureCount      Int              @default(0)
  avgCompletionTime Int?
  isActive          Boolean          @default(true)
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  submissions       FormSubmission[]
  manufacturer      Manufacturer     @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([isActive])
  @@index([verifiedWorking])
}

model FormSubmission {
  id               String                   @id @default(cuid())
  registrationId   String
  templateId       String
  userId           String
  status           String                   @default("IN_PROGRESS")
  startedAt        DateTime                 @default(now())
  completedAt      DateTime?
  currentStep      Int                      @default(1)
  totalSteps       Int
  copiedFields     String                   @default("[]")
  wasHelpful       Boolean?
  difficultyRating Int?
  feedback         String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  template         ManufacturerFormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([registrationId])
  @@index([templateId])
  @@index([userId])
  @@index([status])
}
